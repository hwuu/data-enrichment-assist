<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GaussDB 运维工单浏览器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Panel - Logo, Filters, and List */
        .left-panel {
            width: 320px;
            min-width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* Logo Section */
        .logo-section {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .logo-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .logo-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Control Panel */
        .control-panel {
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .filtering-control, .sorting-control {
            padding: 16px;
            max-height: 400px;
            transition: all 0.4s ease;
            overflow: hidden;
        }

        .filtering-control.collapsed, .sorting-control.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .sorting-control {
            border-top: 1px solid #eee;
        }

        .selection-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .selection-group:last-of-type {
            margin-bottom: 0;
        }

        .selection-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
            min-width: 60px;
        }

        .selection-select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            color: #333;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }

        .selection-select:hover {
            border-color: #667eea;
        }

        .selection-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-clear, .btn-reset-sort {
            margin-top: 10px;
        }

        /* Control Panel Buttons - Unified Style */
        .btn-control {
            width: 100%;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-control:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-clear, .btn-reset-sort {
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
        }

        .btn-clear:hover:not(:disabled), .btn-reset-sort:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        /* Toggle Button with Filter Summary */
        .control-panel-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 10px 16px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.2s;
        }

        .control-panel-toggle:hover {
            background: #eaeaea;
        }

        .control-panel-toggle .summary-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-panel-toggle .toggle-icon {
            font-size: 12px;
            color: #999;
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .control-panel-toggle.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .control-panel-toggle .filter-count {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .control-panel-toggle .filter-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        .control-panel-toggle .sort-tag {
            display: inline-block;
            background: #9e9e9e;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        .control-panel-toggle .no-filter {
            color: #666;
            font-size: 13px;
        }

        /* Ticket List */
        .ticket-list {
            flex: 1;
            overflow-y: auto;
        }

        .ticket-item {
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ticket-item:hover {
            background: #f9f9f9;
        }

        .ticket-item.selected {
            background: #e8eaf6;
            border-left: 4px solid #667eea;
        }

        .ticket-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .ticket-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            color: #667eea;
        }

        .review-icon {
            margin-right: 5px;
            font-size: 12px;
        }

        .review-icon.pass {
            color: #4caf50;
        }

        .review-icon.fail {
            color: #f44336;
        }

        .review-icon.pending {
            color: #ff9800;
        }

        .review-icon.none {
            color: #9e9e9e;
        }

        .review-icon.expired {
            color: #9c27b0;
        }

        .ticket-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            background: #e3f2fd;
            color: #1565c0;
        }

        .ticket-problem {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ticket-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 11px;
            color: #999;
        }

        .ticket-score {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .score-value {
            font-weight: 600;
        }

        .score-value.high {
            color: #4caf50;
        }

        .score-value.medium {
            color: #ff9800;
        }

        .score-value.low {
            color: #f44336;
        }

        /* Right Panel - Detail View */
        .right-panel {
            flex: 1;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow-y: auto;
            padding: 24px;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 14px;
        }

        /* Detail Header with Score */
        .detail-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #3e3e3e;
        }

        .detail-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .detail-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-id {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #9cdcfe;
        }

        .ticket-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #4fc3f7;
            color: #1a1a2e;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .ticket-link:hover {
            background: #29b6f6;
        }

        .detail-type {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        /* Score Card */
        .score-card {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #252526;
            padding: 14px 18px;
            border-radius: 6px;
            /*border-left: 4px solid #569cd6;*/
        }

        .score-badge {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .score-badge.high {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4caf50;
            color: #4caf50;
        }

        .score-badge.medium {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid #ff9800;
            color: #ff9800;
        }

        .score-badge.low {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            color: #f44336;
        }

        .score-detail {
            font-size: 14px;
            line-height: 1.6;
        }

        .score-detail .diff {
            color: #858585;
            margin-bottom: 4px;
        }

        .score-detail .reason {
            color: #d4d4d4;
        }

        /* Review Section */
        .review-card {
            background: #252526;
            padding: 16px;
            border-radius: 6px;
        }

        .review-meta {
            display: flex;
            gap: 24px;
            font-size: 12px;
            color: #858585;
            margin-bottom: 12px;
        }

        .review-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
        }

        .review-textarea:focus {
            outline: none;
            border-color: #569cd6;
        }

        .review-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
        }

        .btn-review {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: #0e639c;
            border: 1px solid #0e639c;
            color: white;
        }

        .btn-save:hover:not(:disabled) {
            background: #1177bb;
        }

        .btn-restore {
            background: transparent;
            border: 1px solid #5a5a5a;
            color: #d4d4d4;
        }

        .btn-restore:hover:not(:disabled) {
            background: #3e3e3e;
        }

        .btn-review:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Review Radio Options */
        .review-conclusion {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
        }

        .review-conclusion label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #d4d4d4;
        }

        .review-conclusion input[type="radio"] {
            accent-color: #569cd6;
            cursor: pointer;
        }

        /* Review Banner */
        .review-banner {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: auto;
            display: none;
        }

        .review-banner.visible {
            display: inline-block;
        }

        .review-banner.success {
            background: rgba(46, 125, 50, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }

        .review-banner.info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #2196f3;
        }

        .review-banner.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #858585;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-label {
            color: #9cdcfe;
        }

        /* Detail Sections */
        .detail-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #4ec9b0;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: #2d2d2d;
            /* border-left: 4px solid #4ec9b0; */
        }

        .section-content {
            padding: 0 12px;
        }

        .info-text {
            background: #252526;
            padding: 14px 16px;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
            /* border-left: 4px solid #569cd6; */
        }

        /* Analysis Steps */
        .step-list {
            list-style: none;
        }

        .step-item, .solution-item {
            background: #252526;
            padding: 14px 16px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .step-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: #569cd6;
            color: #1e1e1e;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .step-title {
            color: #569cd6;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step-detail {
            margin-left: 34px;
            font-size: 13px;
            line-height: 1.5;
        }

        .step-detail .label {
            color: #9cdcfe;
        }

        .command-block {
            background: #1e1e1e;
            padding: 12px;
            border-radius: 4px;
            margin-top: 8px;
            margin-left: 34px;
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 12px;
            color: #ce9178;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .right-panel::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Footer */
        .footer {
            padding: 10px 16px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            background: #fafafa;
        }

        .btn-export-footer {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px 16px;
            border: 1px solid #21A366;
            border-radius: 4px;
            background: #21A366;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export-footer:hover {
            background: #1e8f59;
            border-color: #1e8f59;
        }

        .btn-export-footer .export-icon {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Logo -->
            <div class="logo-section">
                <div class="logo-title">GaussDB Ops Viewer</div>
                <div class="logo-subtitle">运维工单浏览器</div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="filtering-control collapsed" id="filteringControl">
                    <div class="selection-group">
                        <label class="selection-label">问题类型</label>
                        <select class="selection-select" id="typeFilter">
                            <option value="all">全部</option>
                            {% for t in issue_types %}
                            <option value="{{ t }}">{{ t }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="selection-group">
                        <label class="selection-label">负责人</label>
                        <select class="selection-select" id="ownerFilter">
                            <option value="all">全部</option>
                            {% for o in owners %}
                            <option value="{{ o }}">{{ o }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="selection-group">
                        <label class="selection-label">得分范围</label>
                        <select class="selection-select" id="scoreFilter">
                            <option value="all">全部</option>
                            <option value="high">高分 (8-10)</option>
                            <option value="medium">中等 (6-8)</option>
                            <option value="low">低分 (0-6)</option>
                        </select>
                    </div>
                    <div class="selection-group">
                        <label class="selection-label">审核状态</label>
                        <select class="selection-select" id="reviewFilter">
                            <option value="all">全部</option>
                            <option value="通过">通过</option>
                            <option value="不通过">不通过</option>
                            <option value="待定">待定</option>
                            <option value="expired">过期</option>
                            <option value="pending">未审核</option>
                        </select>
                    </div>
                    <button class="btn-control btn-clear" id="clearBtn" onclick="clearFilters()" disabled>清除所有过滤条件</button>
                </div>
                <div class="sorting-control collapsed" id="sortingControl">
                    <div class="selection-group">
                        <label class="selection-label">排序方式</label>
                        <select class="selection-select" id="sortFilter">
                            <option value="updateTime-desc">更新时间 ↓</option>
                            <option value="updateTime-asc">更新时间 ↑</option>
                            <option value="createTime-desc">创建时间 ↓</option>
                            <option value="createTime-asc">创建时间 ↑</option>
                            <option value="id-asc">ID ↑</option>
                            <option value="id-desc">ID ↓</option>
                            <option value="score-desc">评分 ↓</option>
                            <option value="score-asc">评分 ↑</option>
                        </select>
                    </div>
                    <button class="btn-control btn-reset-sort" id="resetSortBtn" onclick="resetSort()" disabled>恢复默认排序方式</button>
                </div>
                <button class="control-panel-toggle collapsed" id="controlPanelToggle" onclick="toggleControlPanel()">
                    <span class="summary-content" id="filterSummary"><span class="no-filter">共 {{ tickets|length }} 条工单</span></span>
                    <span class="toggle-icon">▲</span>
                </button>
            </div>

            <!-- Ticket List -->
            <div class="ticket-list" id="ticketList">
                <!-- Tickets will be rendered here -->
            </div>

            <!-- Footer with Export -->
            <div class="footer">
                <button class="btn-export-footer" onclick="exportToExcel()">
                    <span class="export-icon">↓</span> 导出 Excel
                </button>
            </div>
        </div>

        <!-- Right Panel - Detail View -->
        <div class="right-panel" id="detailPanel">
            <div class="empty-state">
                <span>&#x1F448; 从列表中选择一个工单查看详情</span>
            </div>
        </div>
    </div>

    <script>
        // Ticket data from Flask
        const ticketsData = {{ tickets | tojson }};

        let currentFilters = {
            type: 'all',
            owner: 'all',
            score: 'all',
            review: 'all',
            sort: 'updateTime-desc'
        };
        let selectedTicketId = null;
        let controlPanelCollapsed = true;

        // Ticket URL pattern from backend
        const ticketUrlPattern = '{{ ticket_url_pattern }}';

        // Review state
        let originalReviewConclusion = '';
        let originalReviewContent = '';
        let currentReviewProcessId = null;

        // Initialize
        function init() {
            loadFromUrl();
            renderTicketList();
            setupFilterHandlers();
            // Handle URL hash for deep linking on page load
            handleUrlHash();
        }

        // Toggle control panel
        function toggleControlPanel() {
            controlPanelCollapsed = !controlPanelCollapsed;
            const filteringControl = document.getElementById('filteringControl');
            const sortingControl = document.getElementById('sortingControl');
            const toggle = document.getElementById('controlPanelToggle');

            if (controlPanelCollapsed) {
                filteringControl.classList.add('collapsed');
                sortingControl.classList.add('collapsed');
                toggle.classList.add('collapsed');
            } else {
                filteringControl.classList.remove('collapsed');
                sortingControl.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
            }
        }

        // Update filter summary display
        function updateFilterSummary() {
            const summary = document.getElementById('filterSummary');
            const tags = [];
            const filteredCount = getFilteredTickets().length;
            const totalCount = ticketsData.length;

            if (currentFilters.type !== 'all') {
                tags.push(`类型: ${currentFilters.type}`);
            }
            if (currentFilters.owner !== 'all') {
                tags.push(`负责人: ${currentFilters.owner}`);
            }
            if (currentFilters.score !== 'all') {
                const scoreLabels = { high: '高分', medium: '中等', low: '低分' };
                tags.push(`得分: ${scoreLabels[currentFilters.score]}`);
            }
            if (currentFilters.review !== 'all') {
                const reviewLabels = { '通过': '通过', '不通过': '不通过', '待定': '待定', 'expired': '过期', 'pending': '未审核' };
                tags.push(`审核: ${reviewLabels[currentFilters.review]}`);
            }

            // Sort label
            const sortLabels = {
                'updateTime-desc': '更新 ↓',
                'updateTime-asc': '更新 ↑',
                'createTime-desc': '创建 ↓',
                'createTime-asc': '创建 ↑',
                'id-asc': 'ID ↑',
                'id-desc': 'ID ↓',
                'score-desc': '评分 ↓',
                'score-asc': '评分 ↑'
            };

            // Build summary
            let html = `<span class="filter-count">${filteredCount} / ${totalCount}</span>`;
            if (tags.length > 0) {
                html += tags.map(t => `<span class="filter-tag">${t}</span>`).join('');
            }
            // Only show sort tag if not default
            if (currentFilters.sort !== 'updateTime-desc') {
                html += `<span class="sort-tag">${sortLabels[currentFilters.sort]}</span>`;
            }
            summary.innerHTML = html;
        }

        // Get score class
        function getScoreClass(score) {
            if (score >= 8) return 'high';
            if (score >= 6) return 'medium';
            return 'low';
        }

        // Filter and sort tickets
        function getFilteredTickets() {
            let filtered = ticketsData.filter(ticket => {
                if (currentFilters.type !== 'all' && ticket.issueType !== currentFilters.type) {
                    return false;
                }
                if (currentFilters.owner !== 'all' && ticket.owner !== currentFilters.owner) {
                    return false;
                }
                if (currentFilters.score !== 'all') {
                    const score = ticket.score;
                    if (currentFilters.score === 'high' && score < 8) return false;
                    if (currentFilters.score === 'medium' && (score < 6 || score >= 8)) return false;
                    if (currentFilters.score === 'low' && score >= 6) return false;
                }
                if (currentFilters.review !== 'all') {
                    if (currentFilters.review === 'pending') {
                        // 未审核: no review exists
                        if (ticket.hasReview) return false;
                    } else if (currentFilters.review === 'expired') {
                        // 过期: has review but expired
                        if (!ticket.reviewExpired) return false;
                    } else {
                        // 通过/不通过/待定: match conclusion (and not expired)
                        if (ticket.reviewExpired || ticket.conclusion !== currentFilters.review) return false;
                    }
                }
                return true;
            });

            // Sort
            const [sortField, sortOrder] = currentFilters.sort.split('-');
            filtered.sort((a, b) => {
                let valA, valB;
                if (sortField === 'id') {
                    valA = a.processId || '';
                    valB = b.processId || '';
                } else if (sortField === 'score') {
                    valA = a.score || 0;
                    valB = b.score || 0;
                } else if (sortField === 'createTime') {
                    valA = a.createTime || '';
                    valB = b.createTime || '';
                } else if (sortField === 'updateTime') {
                    valA = a.updateTime || '';
                    valB = b.updateTime || '';
                }

                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        }

        // Get review status icon
        function getReviewIcon(ticket) {
            if (!ticket.hasReview) return '<span class="review-icon none">○</span>';
            if (ticket.reviewExpired) return '<span class="review-icon expired">⚠</span>';
            switch (ticket.conclusion) {
                case '通过': return '<span class="review-icon pass">✓</span>';
                case '不通过': return '<span class="review-icon fail">✗</span>';
                case '待定': return '<span class="review-icon pending">◐</span>';
                default: return '<span class="review-icon none">○</span>';
            }
        }

        // Render ticket list
        function renderTicketList() {
            const listEl = document.getElementById('ticketList');
            const filtered = getFilteredTickets();

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="empty-state">未找到工单</div>';
                return;
            }

            listEl.innerHTML = filtered.map(ticket => {
                const scoreClass = getScoreClass(ticket.score);
                const isSelected = ticket.processId === selectedTicketId;

                return `
                    <div class="ticket-item ${isSelected ? 'selected' : ''}"
                         onclick="selectTicket('${ticket.processId}')"
                         data-id="${ticket.processId}">
                        <div class="ticket-header">
                            ${getReviewIcon(ticket)}<span class="ticket-id">${ticket.processId}</span>
                            <span class="ticket-type">${ticket.issueType}</span>
                        </div>
                        <div class="ticket-problem">${ticket.problem}</div>
                        <div class="ticket-meta">
                            <span>${ticket.owner} / ${ticket.updateTime.split(' ')[0]}</span>
                            <span class="ticket-score">
                                得分: <span class="score-value ${scoreClass}">${ticket.score}</span>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select ticket
        function selectTicket(processId, scrollToView = true) {
            selectedTicketId = processId;

            // Update URL
            updateUrl();

            // Update selection UI
            document.querySelectorAll('.ticket-item').forEach(el => {
                el.classList.remove('selected');
            });

            const selectedItem = document.querySelector(`.ticket-item[data-id="${processId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');

                // Scroll to visible area if needed
                if (scrollToView) {
                    const listPane = document.getElementById('ticketList');
                    const itemRect = selectedItem.getBoundingClientRect();
                    const paneRect = listPane.getBoundingClientRect();

                    // Check if item is in visible range
                    const isVisible = itemRect.top >= paneRect.top && itemRect.bottom <= paneRect.bottom;

                    if (!isVisible) {
                        selectedItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }
            }

            // Fetch ticket detail from API
            fetchTicketDetail(processId);
        }

        // Fetch ticket detail from API
        async function fetchTicketDetail(processId) {
            const panel = document.getElementById('detailPanel');
            panel.innerHTML = '<div class="empty-state">加载中...</div>';

            try {
                const response = await fetch(`/api/tickets/${processId}`);
                const ticket = await response.json();
                if (ticket.error) {
                    panel.innerHTML = '<div class="empty-state">工单未找到</div>';
                } else {
                    renderDetail(ticket);
                    // Fetch review after rendering detail
                    fetchReview(processId);
                }
            } catch (error) {
                panel.innerHTML = '<div class="empty-state">加载失败</div>';
            }
        }

        // Fetch review for current ticket
        async function fetchReview(processId) {
            currentReviewProcessId = processId;
            try {
                const response = await fetch(`/api/tickets/${processId}/review`);
                const review = await response.json();

                originalReviewConclusion = review.conclusion || '';
                originalReviewContent = review.content || '';

                // Set radio button
                const radios = document.querySelectorAll('input[name="reviewConclusion"]');
                radios.forEach(r => {
                    r.checked = r.value === originalReviewConclusion;
                    r.onchange = updateReviewButtons;
                });

                document.getElementById('reviewContent').value = originalReviewContent;
                document.getElementById('reviewCreateTime').textContent = formatUtcToLocal(review.createTime);
                document.getElementById('reviewUpdateTime').textContent = formatUtcToLocal(review.updateTime);

                // Setup textarea listener
                const textarea = document.getElementById('reviewContent');
                textarea.oninput = updateReviewButtons;

                updateReviewButtons();
            } catch (error) {
                console.error('Failed to fetch review:', error);
            }
        }

        // Save review
        async function saveReview() {
            if (!currentReviewProcessId) return;

            // Get selected conclusion
            const selectedRadio = document.querySelector('input[name="reviewConclusion"]:checked');
            const conclusion = selectedRadio ? selectedRadio.value : '';
            const content = document.getElementById('reviewContent').value.trim();

            // Validation
            if (!conclusion) {
                showReviewBanner('请选择审核结论', 'error');
                return;
            }
            if (!content && conclusion !== '通过') {
                showReviewBanner('请填写具体意见', 'error');
                return;
            }

            const btnSave = document.getElementById('btnSaveReview');
            btnSave.disabled = true;
            btnSave.textContent = '保存中...';

            try {
                const response = await fetch(`/api/tickets/${currentReviewProcessId}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conclusion, content })
                });
                const review = await response.json();

                originalReviewConclusion = review.conclusion;
                originalReviewContent = review.content;
                document.getElementById('reviewCreateTime').textContent = formatUtcToLocal(review.createTime);
                document.getElementById('reviewUpdateTime').textContent = formatUtcToLocal(review.updateTime);

                // Update ticketsData and refresh list
                const ticket = ticketsData.find(t => t.processId === currentReviewProcessId);
                if (ticket) {
                    ticket.hasReview = true;
                    ticket.conclusion = review.conclusion;
                    ticket.reviewExpired = false;
                    renderTicketList();
                }

                updateReviewButtons();
                showReviewBanner('保存成功', 'success');
            } catch (error) {
                console.error('Failed to save review:', error);
                showReviewBanner('保存失败', 'error');
            } finally {
                btnSave.textContent = '保存';
            }
        }

        // Restore review to original content
        function restoreReview() {
            // Restore conclusion radio
            const radios = document.querySelectorAll('input[name="reviewConclusion"]');
            radios.forEach(r => {
                r.checked = r.value === originalReviewConclusion;
            });

            document.getElementById('reviewContent').value = originalReviewContent;
            updateReviewButtons();
            showReviewBanner('已还原', 'info');
        }

        // Update review button states
        function updateReviewButtons() {
            const content = document.getElementById('reviewContent').value;
            const selectedRadio = document.querySelector('input[name="reviewConclusion"]:checked');
            const conclusion = selectedRadio ? selectedRadio.value : '';

            const conclusionChanged = conclusion !== originalReviewConclusion;
            const contentChanged = content !== originalReviewContent;
            const hasChanges = conclusionChanged || contentChanged;
            const hasOriginal = originalReviewConclusion !== '' || originalReviewContent !== '';

            document.getElementById('btnSaveReview').disabled = !hasChanges;
            document.getElementById('btnRestoreReview').disabled = !hasChanges || !hasOriginal;
        }

        // Show review banner with auto-hide
        function showReviewBanner(message, type) {
            const banner = document.getElementById('reviewBanner');
            banner.textContent = message;
            banner.className = 'review-banner visible ' + type;

            setTimeout(() => {
                banner.classList.remove('visible');
            }, 2500);
        }

        // Handle URL hash for deep linking
        function handleUrlHash() {
            const hash = window.location.hash.slice(1); // Remove # symbol
            if (hash) {
                // Find matching ticket
                const ticket = ticketsData.find(t => t.processId === hash);
                if (ticket) {
                    selectTicket(hash, true);
                }
            }
        }

        // Listen for hash changes
        window.addEventListener('hashchange', () => {
            handleUrlHash();
        });

        // Render detail view
        function renderDetail(ticket) {
            const panel = document.getElementById('detailPanel');
            const scoreClass = getScoreClass(ticket.score);

            // Generate ticket URL if pattern is set
            let ticketLink = '';
            if (ticketUrlPattern) {
                const ticketUrl = ticketUrlPattern.replace('{processId}', ticket.processId);
                ticketLink = `<a href="${ticketUrl}" target="_blank" class="ticket-link" title="在新标签页打开">↗</a>`;
            }

            let html = `
                <div class="detail-header">
                    <div class="detail-title-row">
                        <div class="detail-title">
                            <span class="detail-id">${ticket.processId}</span>
                            ${ticketLink}
                            <span class="detail-type ticket-type">${ticket.issueType}</span>
                        </div>
                    </div>
                    <div class="detail-meta">
                        <div class="meta-item">
                            <span class="meta-label">负责人:</span>
                            <span>${ticket.owner}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">创建时间:</span>
                            <span>${ticket.createTime}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">更新时间:</span>
                            <span>${ticket.updateTime}</span>
                        </div>
                    </div>
                </div>

                <!-- Expert Review -->
                <div class="detail-section" id="reviewSection">
                    <div class="section-title">审核意见</div>
                    <div class="section-content">
                        <div class="review-card">
                            <div class="review-meta">
                                <span>创建时间: <span id="reviewCreateTime">-</span></span>
                                <span>更新时间: <span id="reviewUpdateTime">-</span></span>
                            </div>
                            <div class="review-conclusion">
                                <label><input type="radio" name="reviewConclusion" value="通过"> 通过</label>
                                <label><input type="radio" name="reviewConclusion" value="不通过"> 不通过</label>
                                <label><input type="radio" name="reviewConclusion" value="待定"> 待定</label>
                            </div>
                            <textarea class="review-textarea" id="reviewContent" placeholder="输入具体意见..."></textarea>
                            <div class="review-actions">
                                <button class="btn-review btn-save" id="btnSaveReview" onclick="saveReview()" disabled>保存</button>
                                <button class="btn-review btn-restore" id="btnRestoreReview" onclick="restoreReview()" disabled>还原</button>
                                <span class="review-banner" id="reviewBanner"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Score Card -->
                <div class="detail-section">
                    <div class="section-title">质量评分</div>
                    <div class="section-content">
                        <div class="score-card">
                            <div class="score-badge ${scoreClass}">${ticket.score}</div>
                            <div class="score-detail">
                                <div class="diff">diff_score: ${ticket.diffScore}</div>
                                <div class="reason">${formatText(ticket.reason)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 1: 问题描述 -->
                <div class="detail-section">
                    <div class="section-title">问题描述</div>
                    <div class="section-content">
                        <div class="info-text">${formatText(ticket.problem)}</div>
                    </div>
                </div>

                <!-- Section 2: 问题根因 -->
                <div class="detail-section">
                    <div class="section-title">问题根因</div>
                    <div class="section-content">
                        <div class="info-text">${formatText(ticket.rootCause)}</div>
                    </div>
                </div>

                <!-- Section 3: 分析过程 -->
                <div class="detail-section">
                    <div class="section-title">分析过程</div>
                    <div class="section-content">
                        <ul class="step-list">
            `;

            ticket.analysis.forEach((step, idx) => {
                html += `
                    <li class="step-item">
                        <div class="step-title">
                            <span class="step-number">${idx + 1}</span>
                            ${formatText(step['操作'])}
                        </div>
                        <div class="step-detail">
                            <p><span class="label">现象:</span> ${formatText(step['现象'])}</p>
                            <p><span class="label">分析:</span> ${formatText(step['现象分析'])}</p>
                        </div>
                    </li>
                `;
            });

            html += `
                        </ul>
                    </div>
                </div>

                <!-- Section 4: 解决方案 -->
                <div class="detail-section">
                    <div class="section-title">解决方案</div>
                    <div class="section-content">
                        <ul class="step-list">
            `;

            ticket.solution.forEach((step, idx) => {
                html += `
                    <li class="solution-item">
                        <div class="step-title">
                            <span class="step-number">${idx + 1}</span>
                            ${formatText(step['描述'])}
                        </div>
                        <div class="command-block">${formatText(step['具体命令'])}</div>
                    </li>
                `;
            });

            html += `
                        </ul>
                    </div>
                </div>
            `;

            panel.innerHTML = html;
            panel.scrollTop = 0;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format text: escape HTML and convert newlines to <br>
        function formatText(text) {
            if (!text) return '';
            return escapeHtml(text).replace(/\n/g, '<br>');
        }

        // Format UTC time to local time
        function formatUtcToLocal(utcString) {
            if (!utcString) return '-';
            const date = new Date(utcString);
            if (isNaN(date.getTime())) return utcString;
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        }

        // Setup filter handlers
        function setupFilterHandlers() {
            document.getElementById('typeFilter').addEventListener('change', (e) => {
                currentFilters.type = e.target.value;
                updateFilters();
            });

            document.getElementById('ownerFilter').addEventListener('change', (e) => {
                currentFilters.owner = e.target.value;
                updateFilters();
            });

            document.getElementById('scoreFilter').addEventListener('change', (e) => {
                currentFilters.score = e.target.value;
                updateFilters();
            });

            document.getElementById('reviewFilter').addEventListener('change', (e) => {
                currentFilters.review = e.target.value;
                updateFilters();
            });

            document.getElementById('sortFilter').addEventListener('change', (e) => {
                currentFilters.sort = e.target.value;
                updateFilters();
            });
        }

        // Update filters
        function updateFilters() {
            renderTicketList();
            updateClearButton();
            updateFilterSummary();
            updateUrl();
        }

        // Update URL with current state
        function updateUrl() {
            const params = new URLSearchParams();
            if (currentFilters.type !== 'all') params.set('type', currentFilters.type);
            if (currentFilters.owner !== 'all') params.set('owner', currentFilters.owner);
            if (currentFilters.score !== 'all') params.set('score', currentFilters.score);
            if (currentFilters.review !== 'all') params.set('review', currentFilters.review);
            if (currentFilters.sort !== 'updateTime-desc') params.set('sort', currentFilters.sort);

            let url = window.location.pathname;
            const queryString = params.toString();
            if (queryString) url += '?' + queryString;
            if (selectedTicketId) url += '#' + selectedTicketId;

            window.history.replaceState({}, '', url);
        }

        // Load state from URL
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('type')) {
                currentFilters.type = params.get('type');
                document.getElementById('typeFilter').value = currentFilters.type;
            }
            if (params.has('owner')) {
                currentFilters.owner = params.get('owner');
                document.getElementById('ownerFilter').value = currentFilters.owner;
            }
            if (params.has('score')) {
                currentFilters.score = params.get('score');
                document.getElementById('scoreFilter').value = currentFilters.score;
            }
            if (params.has('review')) {
                currentFilters.review = params.get('review');
                document.getElementById('reviewFilter').value = currentFilters.review;
            }
            if (params.has('sort')) {
                currentFilters.sort = params.get('sort');
                document.getElementById('sortFilter').value = currentFilters.sort;
            }

            updateClearButton();
            updateFilterSummary();
        }

        // Check if any filter is active
        function hasActiveFilters() {
            return currentFilters.type !== 'all' ||
                   currentFilters.owner !== 'all' ||
                   currentFilters.score !== 'all' ||
                   currentFilters.review !== 'all';
        }

        // Update clear button state
        function updateClearButton() {
            document.getElementById('clearBtn').disabled = !hasActiveFilters();
            document.getElementById('resetSortBtn').disabled = currentFilters.sort === 'updateTime-desc';
        }

        // Clear all filters (not sort)
        function clearFilters() {
            currentFilters.type = 'all';
            currentFilters.owner = 'all';
            currentFilters.score = 'all';
            currentFilters.review = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('ownerFilter').value = 'all';
            document.getElementById('scoreFilter').value = 'all';
            document.getElementById('reviewFilter').value = 'all';
            updateFilters();
        }

        // Reset sort to default
        function resetSort() {
            currentFilters.sort = 'updateTime-desc';
            document.getElementById('sortFilter').value = 'updateTime-desc';
            updateFilters();
        }

        // Export to Excel
        function exportToExcel() {
            const filteredCount = getFilteredTickets().length;
            if (!confirm(`是否要导出 ${filteredCount} 条问题单评审数据？`)) {
                return;
            }
            const params = new URLSearchParams();
            params.set('type', currentFilters.type);
            params.set('owner', currentFilters.owner);
            params.set('score', currentFilters.score);
            params.set('review', currentFilters.review);
            params.set('sort', currentFilters.sort);
            window.open('/api/export?' + params.toString(), '_blank');
        }

        // Start
        init();
    </script>
</body>
</html>
